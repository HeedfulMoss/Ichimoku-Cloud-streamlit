<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ichimoku Cloud Chart</title>
  <style>
    body { 
      font-family: sans-serif; 
      margin: 0; 
      padding: 1rem; 
      background-color: #f5f5f5;
    }
    #container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #333;
      text-align: center;
    }
    #controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .input-group {
      display: flex;
      flex-direction: column;
    }
    label {
      font-size: 0.8rem;
      margin-bottom: 0.2rem;
      color: #555;
    }
    input {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 0.5rem 1rem;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 1.3rem;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #chart-container {
      width: 100%;
      height: 500px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    #volume-container {
      width: 100%;
      height: 150px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #status {
      margin-top: 1rem;
      padding: 0.5rem;
      background-color: #f8f9fa;
      border-left: 3px solid #4CAF50;
      border-radius: 4px;
    }
    .legend {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
      flex-wrap: wrap;
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .legend-color {
      width: 20px;
      height: 10px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>Ichimoku Cloud Chart</h1>
    
    <div id="controls">
      <div class="input-group">
        <label for="ticker">Ticker Symbol</label>
        <input type="text" id="ticker" placeholder="Enter ticker symbol" value="AAPL">
      </div>
      <div class="input-group">
        <label for="conversion-len">Conversion Line Length</label>
        <input type="number" id="conversion-len" value="9" min="1">
      </div>
      <div class="input-group">
        <label for="base-len">Base Line Length</label>
        <input type="number" id="base-len" value="26" min="1">
      </div>
      <div class="input-group">
        <label for="lagging-len">Lagging Span Length</label>
        <input type="number" id="lagging-len" value="26" min="1">
      </div>
      <div class="input-group">
        <label for="leading-span-b-len">Leading Span B Length</label>
        <input type="number" id="leading-span-b-len" value="52" min="1">
      </div>
      <div class="input-group">
        <label for="cloud-shift">Cloud Shift</label>
        <input type="number" id="cloud-shift" value="26" min="1">
      </div>
      <button id="fetch-btn">Update Chart</button>
    </div>
    
    <div class="legend">
      <div class="legend-item"><span class="legend-color" style="background-color: blue;"></span> Conversion Line (Tenkan-sen)</div>
      <div class="legend-item"><span class="legend-color" style="background-color: orange;"></span> Base Line (Kijun-sen)</div>
      <div class="legend-item"><span class="legend-color" style="background-color: purple;"></span> Lagging Span (Chikou Span)</div>
      <div class="legend-item"><span class="legend-color" style="background-color: green;"></span> Leading Span A</div>
      <div class="legend-item"><span class="legend-color" style="background-color: red;"></span> Leading Span B</div>
      <div class="legend-item"><span class="legend-color" style="background-color: rgba(0,255,0,0.3);"></span> Bullish Cloud</div>
      <div class="legend-item"><span class="legend-color" style="background-color: rgba(255,0,0,0.3);"></span> Bearish Cloud</div>
    </div>
    
    <div id="chart-container"></div>
    <div id="volume-container"></div>
    
    <div id="status">Ready</div>
  </div>

  <!-- Use a specific version of the library to ensure compatibility -->
  <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

  <script>
    // Wait for the library to load
    window.onload = function() {
      // Check if the library loaded correctly
      if (typeof LightweightCharts === 'undefined') {
        console.error('LightweightCharts library not loaded');
        document.getElementById('status').textContent = 'Error: Chart library failed to load';
        return;
      }
      
      console.log('LightweightCharts library loaded:', typeof LightweightCharts);
      
      // Constants
      const API_BASE_URL = 'http://localhost:8000';
      
      // DOM Elements
      const tickerInput = document.getElementById('ticker');
      const conversionLenInput = document.getElementById('conversion-len');
      const baseLenInput = document.getElementById('base-len');
      const laggingLenInput = document.getElementById('lagging-len');
      const leadingSpanBLenInput = document.getElementById('leading-span-b-len');
      const cloudShiftInput = document.getElementById('cloud-shift');
      const fetchButton = document.getElementById('fetch-btn');
      const chartContainer = document.getElementById('chart-container');
      const volumeContainer = document.getElementById('volume-container');
      const statusElement = document.getElementById('status');
      
      // Chart variables
      let chart = null;
      let volumeChart = null;
      let candleSeries = null;
      let volumeSeries = null;
      let tenkanSeries = null;
      let kijunSeries = null;
      let chikouSeries = null;
      let senkouASeries = null;
      let senkouBSeries = null;
      let bullishCloudSeries = null;
      let bearishCloudSeries = null;
      
      // Handle window resize (add only once)
      let resizeHandlerAdded = false;
      
      // Initialize charts
      function initCharts() {
        try {
          // Clear previous charts if they exist
          if (chart) chart.remove();
          if (volumeChart) volumeChart.remove();
          chartContainer.innerHTML = '';
          volumeContainer.innerHTML = '';
          
          console.log('Creating main chart...');
          // Create main chart
          chart = LightweightCharts.createChart(chartContainer, {
            width: chartContainer.clientWidth,
            height: 500,
            layout: {
              background: { type: 'solid', color: 'white' },
              textColor: '#333',
            },
            grid: {
              vertLines: { color: 'rgba(197, 203, 206, 0.5)' },
              horzLines: { color: 'rgba(197, 203, 206, 0.5)' }
            },
            crosshair: {
              mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
              borderColor: 'rgba(197, 203, 206, 0.8)',
            },
            timeScale: {
              borderColor: 'rgba(197, 203, 206, 0.8)',
              timeVisible: true,
              rightOffset: 30,
              barSpacing: 15,
            },
          });
          
          // Create volume chart
          volumeChart = LightweightCharts.createChart(volumeContainer, {
            width: volumeContainer.clientWidth,
            height: 150,
            layout: {
              background: { type: 'solid', color: 'white' },
              textColor: '#333',
            },
            grid: {
              vertLines: { color: 'rgba(197, 203, 206, 0.5)' },
              horzLines: { color: 'rgba(197, 203, 206, 0.5)' }
            },
            rightPriceScale: {
              scaleMargins: { top: 0.1, bottom: 0.1 },
            },
            timeScale: {
              borderColor: 'rgba(197, 203, 206, 0.8)',
              timeVisible: true,
              rightOffset: 30,
              barSpacing: 15,
            },
          });
          
          // Sync time scales (one-way sync to avoid feedback loop)
          chart.timeScale().subscribeVisibleTimeRangeChange(timeRange => {
            if (timeRange) {
              volumeChart.timeScale().setVisibleRange(timeRange);
            }
          });
          
          // Create series
          candleSeries = chart.addCandlestickSeries({
            upColor: 'rgba(38, 166, 154, 0.9)',
            downColor: 'rgba(239, 83, 80, 0.9)',
            borderVisible: false,
            wickUpColor: 'rgba(38, 166, 154, 0.9)',
            wickDownColor: 'rgba(239, 83, 80, 0.9)',
          });
          
          volumeSeries = volumeChart.addHistogramSeries({
            color: '#26a69a',
            priceFormat: { type: 'volume' },
          });
          
          // Create Ichimoku series
          tenkanSeries = chart.addLineSeries({
            color: 'blue',
            lineWidth: 2,
            title: 'Conversion Line (Tenkan-sen)',
          });
          
          kijunSeries = chart.addLineSeries({
            color: 'orange',
            lineWidth: 2,
            title: 'Base Line (Kijun-sen)',
          });
          
          chikouSeries = chart.addLineSeries({
            color: 'purple',
            lineWidth: 1,
            title: 'Lagging Span (Chikou Span)',
          });
          
          senkouASeries = chart.addLineSeries({
            color: 'green',
            lineWidth: 1,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            title: 'Leading Span A',
          });
          
          senkouBSeries = chart.addLineSeries({
            color: 'red',
            lineWidth: 1,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            title: 'Leading Span B',
          });
          
          // Create cloud area series
          bullishCloudSeries = chart.addAreaSeries({
            topColor: 'rgba(0, 255, 0, 0.3)',
            bottomColor: 'rgba(0, 255, 0, 0.1)',
            lineColor: 'transparent',
            lineWidth: 0,
            crosshairMarkerVisible: false,
            lastValueVisible: false,
            priceLineVisible: false,
          });
          
          bearishCloudSeries = chart.addAreaSeries({
            topColor: 'rgba(255, 0, 0, 0.3)',
            bottomColor: 'rgba(255, 0, 0, 0.1)',
            lineColor: 'transparent',
            lineWidth: 0,
            crosshairMarkerVisible: false,
            lastValueVisible: false,
            priceLineVisible: false,
          });

          console.log('Charts initialized successfully');
          
          // Add resize handler only once
          if (!resizeHandlerAdded) {
            window.addEventListener('resize', () => {
              if (chart) {
                chart.applyOptions({ width: chartContainer.clientWidth });
              }
              if (volumeChart) {
                volumeChart.applyOptions({ width: volumeContainer.clientWidth });
              }
            });
            resizeHandlerAdded = true;
          }

          return true;
        } catch (error) {
          console.error('Error initializing charts:', error);
          statusElement.textContent = `Error initializing charts: ${error.message}`;
          return false;
        }
      }
      
      // Function to update status message
      function updateStatus(message, isLoading = false) {
        statusElement.textContent = message;
        fetchButton.disabled = isLoading;
        console.log(message);
      }
      
      // Function to format data for charts
      function formatCandlestickData(data) {
        return data.filter(item => 
          item.time && item.open !== null && item.high !== null && 
          item.low !== null && item.close !== null
        ).map(item => ({
          time: item.time,
          open: item.open,
          high: item.high,
          low: item.low,
          close: item.close
        }));
      }
      
      function formatVolumeData(data) {
        return data.filter(item => 
          item.time && item.volume !== null
        ).map(item => ({
          time: item.time,
          value: item.volume,
          color: item.close > item.open ? 'rgba(38, 166, 154, 0.9)' : 'rgba(239, 83, 80, 0.9)'
        }));
      }
      
      function formatLineData(data, field) {
        return data.filter(item => 
          item.time && item[field] !== null && item[field] !== undefined && !isNaN(item[field])
        ).map(item => ({
          time: item.time,
          value: item[field]
        }));
      }
      
      // Function to create cloud data
      function createCloudData(data) {
        const bullishData = [];
        const bearishData = [];
        
        for (const item of data) {
          if (item.senkou_span_a !== null && item.senkou_span_b !== null && 
              !isNaN(item.senkou_span_a) && !isNaN(item.senkou_span_b)) {
            
            if (item.senkou_span_a >= item.senkou_span_b) {
              // Bullish cloud
              bullishData.push({
                time: item.time,
                value: Math.max(item.senkou_span_a, item.senkou_span_b)
              });
              bearishData.push({
                time: item.time,
                value: Math.min(item.senkou_span_a, item.senkou_span_b)
              });
            } else {
              // Bearish cloud
              bearishData.push({
                time: item.time,
                value: Math.max(item.senkou_span_a, item.senkou_span_b)
              });
              bullishData.push({
                time: item.time,
                value: Math.min(item.senkou_span_a, item.senkou_span_b)
              });
            }
          }
        }
        
        return { bullishData, bearishData };
      }
      
      // Function to fetch and display data
      async function fetchAndDisplayData() {
        const ticker = tickerInput.value.trim().toUpperCase();
        
        if (!ticker) {
          updateStatus('Please enter a ticker symbol');
          return;
        }
        
        updateStatus(`Fetching data for ${ticker}...`, true);
        
        try {
          // Initialize charts if they don't exist
          if (!chart || !volumeChart) {
            if (!initCharts()) {
              throw new Error('Failed to initialize charts');
            }
          }
          
          // Step 1: Fetch raw OHLCV data
          const response = await fetch(`${API_BASE_URL}/data/${ticker}`);
          
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          
          const rawData = await response.json();
          console.log("Raw data received:", rawData);
          
          if (!rawData || !rawData.data || !Array.isArray(rawData.data)) {
            throw new Error('Invalid data format received');
          }
          
          if (rawData.data.length === 0) {
            updateStatus(`No data available for ${ticker}`);
            return;
          }
          
          updateStatus(`Calculating Ichimoku indicators for ${ticker}...`, true);
          
          // Step 2: Send data to Ichimoku endpoint with parameters
          const ichimokuRequest = {
            data: rawData.data,
            conversion_len: parseInt(conversionLenInput.value),
            base_len: parseInt(baseLenInput.value),
            lagging_len: parseInt(laggingLenInput.value),
            leading_span_b_len: parseInt(leadingSpanBLenInput.value),
            cloud_shift: parseInt(cloudShiftInput.value)
          };
          
          const ichimokuResponse = await fetch(`${API_BASE_URL}/ichimoku`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(ichimokuRequest)
          });
          
          if (!ichimokuResponse.ok) {
            throw new Error(`Ichimoku calculation failed! Status: ${ichimokuResponse.status}`);
          }
          
          const ichimokuData = await ichimokuResponse.json();
          console.log("Ichimoku data received:", ichimokuData);
          
          if (!ichimokuData || !ichimokuData.data || !Array.isArray(ichimokuData.data)) {
            throw new Error('Invalid Ichimoku data format received');
          }
          
          updateStatus(`Rendering chart for ${ticker}...`, true);
          
          // Step 3: Format and set all data
          const candleData = formatCandlestickData(ichimokuData.data);
          const volumeData = formatVolumeData(ichimokuData.data);
          
          // Set candlestick and volume data
          candleSeries.setData(candleData);
          volumeSeries.setData(volumeData);
          
          // Set Ichimoku line data
          tenkanSeries.setData(formatLineData(ichimokuData.data, 'tenkan_sen'));
          kijunSeries.setData(formatLineData(ichimokuData.data, 'kijun_sen'));
          chikouSeries.setData(formatLineData(ichimokuData.data, 'chikou_span'));
          senkouASeries.setData(formatLineData(ichimokuData.data, 'senkou_span_a'));
          senkouBSeries.setData(formatLineData(ichimokuData.data, 'senkou_span_b'));
          
          // Create and set cloud data
          const { bullishData, bearishData } = createCloudData(ichimokuData.data);
          bullishCloudSeries.setData(bullishData);
          bearishCloudSeries.setData(bearishData);
          
          // Fit content to view
          chart.timeScale().fitContent();
          volumeChart.timeScale().fitContent();
          
          updateStatus(`Successfully loaded Ichimoku chart for ${ticker}`);
          
        } catch (error) {
          console.error('Error:', error);
          updateStatus(`Error: ${error.message}`);
        }
      }
      
      // Event listeners
      fetchButton.addEventListener('click', fetchAndDisplayData);
      
      tickerInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          fetchAndDisplayData();
        }
      });
      
      // Initialize on load
      console.log("Initializing charts on load");
      if (initCharts()) {
        setTimeout(() => {
          console.log("Starting initial data fetch");
          fetchAndDisplayData();
        }, 300);
      }
    };
  </script>
</body>
</html>